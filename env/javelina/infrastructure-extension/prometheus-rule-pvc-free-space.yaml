apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: pvc-free-space-rule
  namespace: prometheus
  labels:
    release: prometheus-stack
spec:
  groups:
    - name: pvc.storage
      rules:
        - alert: PVCFreeSpaceLow
          expr: |
            (
              kubelet_volume_stats_available_bytes
              /
              kubelet_volume_stats_capacity_bytes
            ) * 100 < 15
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "PVC free space low ({{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }})"
            description: |
              PVC {{ $labels.persistentvolumeclaim }} in namespace {{ $labels.namespace }}
              has less than 15% free space remaining.
        - alert: PVCFreeSpaceCritical
          expr: |
            (
              kubelet_volume_stats_available_bytes
              /
              kubelet_volume_stats_capacity_bytes
            ) * 100 < 5
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "PVC free space critical ({{ $labels.namespace }}/{{ $labels.persistentvolumeclaim }})"
            description: |
              PVC {{ $labels.persistentvolumeclaim }} in namespace {{ $labels.namespace }}
              has less than 5% free space remaining.

apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: sudoku-api
  namespace: default
spec:
  chartRef:
    kind: OCIRepository
    name: generic-microservice-helm
    namespace: flux-system
  upgrade:
    remediation:
      retries: 1
  interval: 1m0s
  values:
    podAnnotations:
      reloader.stakater.com/auto: "true"
    fullnameOverride: "sudoku-api"
    image:
      repository: ghcr.io/soft-titus/sudoku-api # {"$imagepolicy": "flux-system:sudoku-api:name"}
      tag: 1.2.0 # {"$imagepolicy": "flux-system:sudoku-api:tag"}
    replicaCount: 1
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi
    container:
      ports:
        http: 8080
    service:
      type: ClusterIP
      ports:
        - port: 80
          name: http
    readinessProbe:
      enabled: true
      httpGet:
        scheme: HTTP
        port: http
        path: /health
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 10
      failureThreshold: 3
      successThreshold: 1
    livenessProbe:
      enabled: true
      httpGet:
        scheme: HTTP
        port: http
        path: /health
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 10
      failureThreshold: 3
      successThreshold: 1
    envFrom:
      - configMapRef:
          name: sudoku-api-configmap
      - configMapRef:
          name: redis-configmap
      - configMapRef:
          name: kafka-configmap
      - configMapRef:
          name: mongo-configmap
      - secretRef:
          name: mongo-secrets
    serviceAccount:
      create: false
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sudoku-api-configmap
  namespace: default
data:
  LOG_LEVEL: "INFO"
  IMAGE_BASE_URL: "https://minio.felabella.local/sudoku"
  CACHE_TTL_HOURS: "168"
  KAFKA_PUZZLE_TOPIC: "sudoku.puzzle.generate"
  MONGO_DB: "sudoku"
  MONGO_COLLECTION_NAME: "puzzle"
  REDIS_DB: "0"
---
apiVersion: image.toolkit.fluxcd.io/v1
kind: ImageRepository
metadata:
  name: sudoku-api
  namespace: flux-system
spec:
  image: ghcr.io/soft-titus/sudoku-api
  interval: 5m0s
---
apiVersion: image.toolkit.fluxcd.io/v1
kind: ImagePolicy
metadata:
  name: sudoku-api
  namespace: flux-system
spec:
  imageRepositoryRef:
    name: sudoku-api
  filterTags:
    pattern: '.*(\-\d+)?(\-|$)[^\-\n]{0,7}$'
  policy:
    semver:
      range: ">= 0.0.0 < 2.0.0"
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: sudoku-api
  namespace: default
spec:
  parentRefs:
    - name: envoy-gateway
      namespace: envoy-gateway-system
  hostnames:
    - "sudoku-api.felabella.local"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: sudoku-api
          port: 80
---
apiVersion: batch/v1
kind: Job
metadata:
  name: sudoku-mongo-index
  namespace: default
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: mongo-indexer
          image: mongo:7.0.28
          command:
            - "sh"
            - "-c"
            - |
              echo "Building MongoDB URI..."
              MONGO_URI="mongodb://$MONGO_USER:$MONGO_PASSWORD@$MONGO_HOST:$MONGO_PORT/$MONGO_DB?replicaSet=mongodb&retryWrites=true&w=majority"

              echo "Waiting for MongoDB primary..."
              until mongosh "$MONGO_URI" --eval "db.hello().isWritablePrimary" --quiet | grep -q true; do
                echo "Primary not ready yet, sleeping 2s..."
                sleep 2
              done

              echo "MongoDB is primary. Creating index..."
              mongosh "$MONGO_URI" --eval "db.getCollection('$MONGO_COLLECTION_NAME').createIndex({ puzzleId: 1 }, { unique: true });"

              echo "MongoDB index creation completed."
          envFrom:
            - configMapRef:
                name: mongo-configmap
            - secretRef:
                name: mongo-secrets
            - configMapRef:
                name: sudoku-api-configmap
